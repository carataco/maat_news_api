name: CD - Deploy Lambdas

on:
  pull_request:
    types: [closed]

jobs:
  detect-changes:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      deploy: ${{ steps.check.outputs.deploy }}
      lambdas: ${{ steps.lambdas.outputs.lambdas }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1️⃣ Detect relevant changes in cmd/ or internal/ or go.mod/sum
      - id: check
        run: |
          git fetch origin main
          BASE=$(git merge-base HEAD origin/main)
          if git diff --name-only $BASE HEAD | grep -Eq '^cmd/|^internal/|go\.mod|go\.sum'; then
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi

      # 2️⃣ Read Lambda names from config.yaml (simple Bash parsing)
      - id: lambdas
        if: steps.check.outputs.deploy == 'true'
        run: |
          LAMBDAS_LIST=()
          capture=false
          while IFS= read -r line || [ -n "$line" ]; do
              trimmed=$(echo "$line" | sed 's/^[[:space:]]*//')
              if [[ "$trimmed" == "lambdas:" ]]; then
                  capture=true
                  continue
              fi
              if $capture && [[ "$trimmed" == -* ]]; then
                  item=$(echo "$trimmed" | sed 's/^-//; s/^[[:space:]]*//')
                  LAMBDAS_LIST+=("$item")
              fi
          done < config.yaml

          # Convert to JSON array for matrix
          LAMBDAS_JSON=$(printf '%s\n' "${LAMBDAS_LIST[@]}" | jq -R . | jq -s .)
          echo "lambdas=$LAMBDAS_JSON" >> $GITHUB_OUTPUT

  no-changes:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.deploy == 'false'
    steps:
      - name: No Lambda changes
        run: echo "No relevant changes detected. Skipping deployment."

  deploy:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.deploy == 'true'
    strategy:
      matrix:
        lambda: ${{ fromJson(needs.detect-changes.outputs.lambdas) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build Lambda binary
        run: |
          echo "Building Lambda binary for ${{ matrix.lambda }}"
          FOLDER=$(echo "${{ matrix.lambda }}" | sed 's/^api_endpoint_//')  # infer folder from name
          mkdir -p build
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 \
          go build -o build/bootstrap ./cmd/$FOLDER/main.go

      - name: Zip Lambda
        run: |
          cd build
          zip ../${{ matrix.lambda }}.zip bootstrap
          cd ..

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

      - name: Deploy Lambda ${{ matrix.lambda }}
        run: |
          echo "Deploying Lambda ${{ matrix.lambda }}"
          aws lambda update-function-code \
            --function-name ${{ matrix.lambda }} \
            --zip-file fileb://${{ matrix.lambda }}.zip
