name: CD - Deploy Lambdas

on:
  pull_request:
    types: [closed]

jobs:
  detect-changes:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      deploy: ${{ steps.check.outputs.deploy }}
      lambdas: ${{ steps.lambdas.outputs.lambdas }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1️⃣ Detect changes in any Lambda folder or internal packages
      - id: check
        run: |
          git fetch origin main
          if git diff --name-only origin/main~1 origin/main | grep -Eq '^cmd/.*/main.go|^internal/|go\.mod|go\.sum'; then
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi

      # 2️⃣ Read Lambda mapping from config.yaml
      - id: lambdas
        if: steps.check.outputs.deploy == 'true'
        run: |
          # Install yq for YAML parsing
          sudo apt-get update && sudo apt-get install -y jq python3-pip
          pip3 install yq

          LAMBDAS_JSON=$(yq -o=json '.lambdas' config.yaml)
          echo "LAMBDAS=$LAMBDAS_JSON"
          echo "lambdas=$LAMBDAS_JSON" >> $GITHUB_OUTPUT

  no-changes:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.deploy == 'false'
    steps:
      - name: No Lambda changes
        run: echo "No relevant changes detected. Skipping deployment."

  deploy:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.deploy == 'true'
    strategy:
      matrix:
        lambda: ${{ fromJson(needs.detect-changes.outputs.lambdas) }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      # 1️⃣ Build the Lambda binary
      - name: Build Lambda binary
        run: |
          echo "Building Lambda binary for ${{ matrix.lambda.lambda_name }}"
          mkdir -p build
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 \
          go build -o build/bootstrap ./cmd/${{ matrix.lambda.folder }}/main.go

      # 2️⃣ Zip the binary
      - name: Zip Lambda
        run: |
          cd build
          zip ../${{ matrix.lambda.lambda_name }}.zip bootstrap
          cd ..

      # 3️⃣ Configure AWS credentials
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

      # 4️⃣ Deploy the Lambda
      - name: Deploy Lambda ${{ matrix.lambda.lambda_name }}
        run: |
          echo "Deploying Lambda ${{ matrix.lambda.lambda_name }}"
          aws lambda update-function-code \
            --function-name ${{ matrix.lambda.lambda_name }} \
            --zip-file fileb://${{ matrix.lambda.lambda_name }}.zip
